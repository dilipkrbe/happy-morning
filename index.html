<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selfie Fortune Teller</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2E7D32;
            --background-color: #f5f5f5;
            --text-color: #333333;
            --accent-color: #FF9800;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            box-sizing: border-box;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        #preview-container {
            width: 100%;
            aspect-ratio: 1/1;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            background-color: #e0e0e0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        #placeholder-text {
            text-align: center;
            color: #757575;
        }
        
        #canvas {
            display: none;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background-color: var(--primary-color);
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .button:hover {
            background-color: var(--secondary-color);
        }
        
        .button:active {
            transform: scale(0.98);
        }
        
        .button-secondary {
            background-color: #9E9E9E;
        }
        
        .button-secondary:hover {
            background-color: #757575;
        }
        
        #camera-input {
            display: none;
        }
        
        #message-container {
            width: 100%;
            max-width: 500px;
            margin-top: 10px;
        }
        
        #message-container {
            position: relative;
        }
        
        #message {
            font-size: 18px;
            line-height: 1.6;
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #save-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
        }
        
        #save-button:hover {
            opacity: 1;
        }
        
        #save-button svg {
            width: 16px;
            height: 16px;
            fill: var(--primary-color);
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--primary-color);
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(76, 175, 80, 0.3);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .consent-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .consent-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
        }
        
        .consent-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 480px) {
            .button {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            #message {
                font-size: 16px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Consent Modal -->
    <div id="consent-modal" class="consent-modal">
        <div class="consent-content">
            <h2>Privacy Notice</h2>
            <p>This app uses Google's Gemini API.</p>
            <p>Your image will be sent to Google's servers for processing. While we don't store your images, 
               Google may use data from the free tier to improve their models.</p>
            <p>By clicking "I Agree", you consent to this processing.</p>
            <div class="consent-buttons">
                <button id="consent-agree" class="button">I Agree</button>
                <button id="consent-disagree" class="button button-secondary">No Thanks</button>
            </div>
        </div>
    </div>

    <h1>Selfie Fortune Teller</h1>
    
    <div class="container">
        <div id="preview-container">
            <img id="preview" alt="Selfie Preview" class="hidden" />
            <p id="placeholder-text">Your selfie will appear here</p>
        </div>
        
        <div class="button-container">
            <button id="capture-btn" class="button">
                <span>Take Selfie</span>
            </button>
            <button id="analyze-btn" class="button" disabled>
                <span>How's My Day</span>
            </button>
        </div>
        
        <input type="file" id="camera-input" accept="image/*" capture="user" aria-label="Take a selfie">
        <canvas id="canvas"></canvas>
    </div>
    
    <div id="message-container">
        <div id="message">Take a selfie!</div>
        <button id="save-button" class="hidden" title="Save this fortune">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
        </button>
    </div>

    <script>
        // DOM Elements
        const cameraInput = document.getElementById('camera-input');
        const preview = document.getElementById('preview');
        const previewContainer = document.getElementById('preview-container');
        const placeholderText = document.getElementById('placeholder-text');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const messageDiv = document.getElementById('message');
        const saveButton = document.getElementById('save-button');
        const consentModal = document.getElementById('consent-modal');
        const consentAgreeBtn = document.getElementById('consent-agree');
        const consentDisagreeBtn = document.getElementById('consent-disagree');
        
        // Global variables
        let userConsent = false;
        let currentImageData = null;
        let currentFortune = null;
        
        // Check for service worker support and register
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
        
        // Consent handling
        consentAgreeBtn.addEventListener('click', () => {
            userConsent = true;
            consentModal.classList.add('hidden');
            localStorage.setItem('selfieAppConsent', 'true');
        });
        
        consentDisagreeBtn.addEventListener('click', () => {
            consentModal.classList.add('hidden');
            messageDiv.textContent = 'You need to consent to use this app. Please reload the page if you change your mind.';
        });
        
        // Check if user has already consented
        if (localStorage.getItem('selfieAppConsent') === 'true') {
            userConsent = true;
            consentModal.classList.add('hidden');
        }
        
        // Trigger camera input
        captureBtn.addEventListener('click', () => {
            if (!userConsent) {
                consentModal.classList.remove('hidden');
                return;
            }
            cameraInput.click();
        });
        
        // Handle camera input
        cameraInput.addEventListener('change', async (event) => {
            const file = cameraInput.files[0];
            if (file) {
                try {
                    // Display preview
                    preview.src = URL.createObjectURL(file);
                    preview.classList.remove('hidden');
                    placeholderText.classList.add('hidden');
                    analyzeBtn.disabled = false;
                    
                    // Reset message and hide save button
                    messageDiv.textContent = 'Looking good! Click "How\'s My Day".';
                    saveButton.classList.add('hidden');
                } catch (error) {
                    messageDiv.textContent = `Error loading image: ${error.message}`;
                }
            }
        });
        
        // Analyze selfie
        analyzeBtn.addEventListener('click', async () => {
            if (!preview.src || preview.classList.contains('hidden')) {
                messageDiv.textContent = 'Please take a selfie first!';
                return;
            }
            
            // Show loading indicator
            messageDiv.innerHTML = '<div class="loading"><div class="spinner"></div><span>Observing your selfie...</span></div>';
            
            // Process image
            try {
                const img = new Image();
                img.src = preview.src;
                
                img.onload = async () => {
                    // Downscale image
                    const ctx = canvas.getContext('2d');
                    const maxSize = 512;
                    let width = img.width;
                    let height = img.height;
                    
                    // Maintain aspect ratio while downscaling
                    if (width > height) {
                        if (width > maxSize) {
                            height = Math.round((height * maxSize) / width);
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = Math.round((width * maxSize) / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Get base64 data
                    const imageData = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Store the current image data for saving later
                    currentImageData = imageData;
                    
                    // Send to API
                    const compliment = await analyzeSelfie(imageData);
                    messageDiv.textContent = compliment;
                    currentFortune = compliment;
                    
                    // Show save button
                    saveButton.classList.remove('hidden');
                };
            } catch (error) {
                messageDiv.textContent = `Error processing image: ${error.message}`;
            }
        });
        
        // Send image to API
        async function analyzeSelfie(imageData) {
            try {
                // Create API endpoint using server-side route that will handle the API key
                const apiEndpoint = '/api/analyze-selfie';
                
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imageData: imageData.split(',')[1] // Remove "data:image/jpeg;base64,"
                    })
                });
                
                const data = await response.json();
                
                if (data.message) {
                    return data.message;
                } else if (data.error) {
                    return `Error: ${data.error}`;
                }
                
                return 'You look fantastic today!';
            } catch (error) {
                console.error('Error analyzing selfie:', error);
                return 'Unable to generate right now. But trust me, you look marvelous!';
            }
        }
        
        // Save fortune functionality
        saveButton.addEventListener('click', async () => {
            if (!currentImageData || !currentFortune) {
                return;
            }
            
            try {
                // Create a hidden canvas to combine the image and text
                const exportCanvas = document.createElement('canvas');
                const ctx = exportCanvas.getContext('2d');
                
                // Load the image
                const img = new Image();
                img.src = currentImageData;
                
                await new Promise((resolve) => {
                    img.onload = resolve;
                });
                
                // Set canvas dimensions
                const padding = 30;
                const textHeight = 150; // Approximate height for text
                exportCanvas.width = img.width;
                exportCanvas.height = img.height + textHeight + padding * 2;
                
                // Fill canvas with white background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
                
                // Draw the image
                ctx.drawImage(img, 0, 0);
                
                // Add the fortune text
                ctx.font = '16px Arial';
                ctx.fillStyle = '#333333';
                ctx.textAlign = 'center';
                
                // Word wrap the text
                const maxWidth = exportCanvas.width - padding * 2;
                const words = currentFortune.split(' ');
                let line = '';
                let y = img.height + padding;
                
                for (let i = 0; i < words.length; i++) {
                    const testLine = line + words[i] + ' ';
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && i > 0) {
                        ctx.fillText(line, exportCanvas.width / 2, y);
                        line = words[i] + ' ';
                        y += 22; // Line height
                    } else {
                        line = testLine;
                    }
                }
                ctx.fillText(line, exportCanvas.width / 2, y);
                
                // Add timestamp at the bottom
                const now = new Date();
                const timestamp = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
                ctx.font = '12px Arial';
                ctx.fillStyle = '#999999';
                ctx.fillText(timestamp, exportCanvas.width / 2, exportCanvas.height - padding);
                
                // Convert to blob and download
                exportCanvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `selfie-fortune-${now.getTime()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 'image/png');
                
            } catch (error) {
                console.error('Error saving fortune:', error);
                messageDiv.textContent = `${currentFortune}\n\n(Error saving: ${error.message})`;
            }
        });
    </script>
</body>
</html>
