<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selfie Fortune Teller</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2E7D32;
            --background-color: #f5f5f5;
            --text-color: #333333;
            --accent-color: #FF9800;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            color: var(--text-color);
            box-sizing: border-box;
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        #preview-container {
            width: 100%;
            aspect-ratio: 1/1;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            background-color: #e0e0e0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        #placeholder-text {
            text-align: center;
            color: #757575;
        }
        
        #canvas {
            display: none;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
            color: white;
            background-color: var(--primary-color);
            border: none;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .button:hover {
            background-color: var(--secondary-color);
        }
        
        .button:active {
            transform: scale(0.98);
        }
        
        .button-secondary {
            background-color: #9E9E9E;
        }
        
        .button-secondary:hover {
            background-color: #757575;
        }
        
        #camera-input {
            display: none;
        }
        
        #message-container {
            width: 100%;
            max-width: 500px;
            margin-top: 10px;
        }
        
        #message {
            font-size: 18px;
            line-height: 1.6;
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--primary-color);
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(76, 175, 80, 0.3);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .consent-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .consent-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
        }
        
        .consent-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 480px) {
            .button {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            #message {
                font-size: 16px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Consent Modal -->
    <div id="consent-modal" class="consent-modal">
        <div class="consent-content">
            <h2>Privacy Notice</h2>
            <p>This app uses Google's Gemini API.</p>
            <p>Your image will be sent to Google's servers for processing. While we don't store your images, 
               Google may use data from the free tier to improve their models.</p>
            <p>By clicking "I Agree", you consent to this processing.</p>
            <div class="consent-buttons">
                <button id="consent-agree" class="button">I Agree</button>
                <button id="consent-disagree" class="button button-secondary">No Thanks</button>
            </div>
        </div>
    </div>

    <h1>Selfie Fortune Teller</h1>
    
    <div class="container">
        <div id="preview-container">
            <img id="preview" alt="Selfie Preview" class="hidden" />
            <p id="placeholder-text">Your selfie will appear here</p>
        </div>
        
        <div class="button-container">
            <button id="capture-btn" class="button">
                <span>Take Selfie</span>
            </button>
            <button id="analyze-btn" class="button" disabled>
                <span>How's My Day</span>
            </button>
        </div>
        
        <input type="file" id="camera-input" accept="image/*" capture="user" aria-label="Take a selfie">
        <canvas id="canvas"></canvas>
    </div>
    
    <div id="message-container">
        <div id="message">Take a selfie!</div>
    </div>

    <script>
        // DOM Elements
        const cameraInput = document.getElementById('camera-input');
        const preview = document.getElementById('preview');
        const previewContainer = document.getElementById('preview-container');
        const placeholderText = document.getElementById('placeholder-text');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('capture-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const messageDiv = document.getElementById('message');
        const consentModal = document.getElementById('consent-modal');
        const consentAgreeBtn = document.getElementById('consent-agree');
        const consentDisagreeBtn = document.getElementById('consent-disagree');
        
        // Global variables
        let userConsent = false;
        let currentImageData = null;
        
        // Check for service worker support and register
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
        
        // Consent handling
        consentAgreeBtn.addEventListener('click', () => {
            userConsent = true;
            consentModal.classList.add('hidden');
            localStorage.setItem('selfieAppConsent', 'true');
        });
        
        consentDisagreeBtn.addEventListener('click', () => {
            consentModal.classList.add('hidden');
            messageDiv.textContent = 'You need to consent to use this app. Please reload the page if you change your mind.';
        });
        
        // Check if user has already consented
        if (localStorage.getItem('selfieAppConsent') === 'true') {
            userConsent = true;
            consentModal.classList.add('hidden');
        }
        
        // Trigger camera input
        captureBtn.addEventListener('click', () => {
            if (!userConsent) {
                consentModal.classList.remove('hidden');
                return;
            }
            cameraInput.click();
        });
        
        // Handle camera input
        cameraInput.addEventListener('change', async (event) => {
            const file = cameraInput.files[0];
            if (file) {
                try {
                    // Display preview
                    preview.src = URL.createObjectURL(file);
                    preview.classList.remove('hidden');
                    placeholderText.classList.add('hidden');
                    analyzeBtn.disabled = false;
                    
                    // Reset message
                    messageDiv.textContent = 'Looking good! Click "How\'s My Day".';
                } catch (error) {
                    messageDiv.textContent = `Error loading image: ${error.message}`;
                }
            }
        });
        
        // Analyze selfie
        analyzeBtn.addEventListener('click', async () => {
            if (!preview.src || preview.classList.contains('hidden')) {
                messageDiv.textContent = 'Please take a selfie first!';
                return;
            }
            
            // Show loading indicator
            messageDiv.innerHTML = '<div class="loading"><div class="spinner"></div><span>Observing your selfie...</span></div>';
            
            // Process image
            try {
                const img = new Image();
                img.src = preview.src;
                
                img.onload = async () => {
                    // Downscale image
                    const ctx = canvas.getContext('2d');
                    const maxSize = 512;
                    let width = img.width;
                    let height = img.height;
                    
                    // Maintain aspect ratio while downscaling
                    if (width > height) {
                        if (width > maxSize) {
                            height = Math.round((height * maxSize) / width);
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width = Math.round((width * maxSize) / height);
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Get base64 data
                    const imageData = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Send to API
                    const compliment = await analyzeSelfie(imageData);
                    messageDiv.textContent = compliment;
                };
            } catch (error) {
                messageDiv.textContent = `Error processing image: ${error.message}`;
            }
        });
        
        // Send image to API
        async function analyzeSelfie(imageData) {
            try {
                // In production, this should call a serverless function instead of direct API access
                const apiEndpoint = '/api/analyze-selfie';
                
                // For demonstration purposes, we'll show the direct API call
                // In production, move this to a serverless function
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyAoaZP1KZShFnwdmjx5XIgey1-fiUXMPAU', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                {
                                    text: 'Analyze this selfie. Based on this, generate a one-paragraph, daily-horoscope-style message that feels personal, uplifting, and emotionally intelligent. Observe and gently interpret the expression of the person, clothing, lighting, and mood - and respond with a feel-good reflection. Start with a warm compliment, suggest what kind of energy or emotion they radiate today, hint at one or two light, joyful moments they might experience, and end with an encouraging suggestion (like showing kindness, smiling more, or embracing the day). Always stay positive, poetic, and emotionally soothing - never generic or templated. Respond purely based on the selfie - dont ask questions or offer advice.'
                                },
                                {
                                    inlineData: {
                                        mimeType: 'image/jpeg',
                                        data: imageData.split(',')[1] // Remove "data:image/jpeg;base64,"
                                    }
                                }
                            ]
                        }]
                    })
                });
                
                const data = await response.json();
                
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                    return data.candidates[0].content.parts[0].text || 'You look amazing!';
                } else if (data.error) {
                    return `API Error: ${data.error.message || 'Unknown error'}`;
                }
                
                return 'You look fantastic today!';
            } catch (error) {
                console.error('Error analyzing selfie:', error);
                return 'Unable to generate right now. But trust me, you look great!';
            }
        }
    </script>
</body>
</html>
